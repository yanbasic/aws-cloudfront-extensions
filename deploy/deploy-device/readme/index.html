<!doctype html><html lang=en class="js csstransforms3d"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.79.1"><meta name=description content><link rel="shortcut icon" href=https://awslabs.github.io/aws-cloudfront-extensions/images/favicon.ico type=image/x-icon><title>Deploy a Lambda@Edge function to serve based on devices :: CloudFront+</title><link href=https://awslabs.github.io/aws-cloudfront-extensions/css/nucleus.css?1620971210 rel=stylesheet><link href=https://awslabs.github.io/aws-cloudfront-extensions/css/fontawesome-all.min.css?1620971210 rel=stylesheet><link href=https://awslabs.github.io/aws-cloudfront-extensions/css/hybrid.css?1620971210 rel=stylesheet><link href=https://awslabs.github.io/aws-cloudfront-extensions/css/featherlight.min.css?1620971210 rel=stylesheet><link href=https://awslabs.github.io/aws-cloudfront-extensions/css/perfect-scrollbar.min.css?1620971210 rel=stylesheet><link href=https://awslabs.github.io/aws-cloudfront-extensions/css/auto-complete.css?1620971210 rel=stylesheet><link href=https://awslabs.github.io/aws-cloudfront-extensions/css/atom-one-dark-reasonable.css?1620971210 rel=stylesheet><link href=https://awslabs.github.io/aws-cloudfront-extensions/css/theme.css?1620971210 rel=stylesheet><link href=https://awslabs.github.io/aws-cloudfront-extensions/css/hugo-theme.css?1620971210 rel=stylesheet><link href=https://awslabs.github.io/aws-cloudfront-extensions/css/theme-cloudfrontext.css?1620971210 rel=stylesheet><script src=https://awslabs.github.io/aws-cloudfront-extensions/js/jquery-3.3.1.min.js?1620971210></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}</style></head><body data-url=https://awslabs.github.io/aws-cloudfront-extensions/deploy/deploy-device/readme/><nav id=sidebar><div id=header-wrapper><div id=header><a id=logo href=https://awslabs.github.io/aws-cloudfront-extensions/><img src=https://awslabs.github.io/aws-cloudfront-extensions/images/logo.png alt="AWS Logo" width=44% height=44%></a></div><div class=searchbox><label for=search-by><i class="fas fa-search"></i></label><input data-search-input id=search-by type=search placeholder=Search...>
<span data-search-clear><i class="fas fa-times"></i></span></div><script type=text/javascript src=https://awslabs.github.io/aws-cloudfront-extensions/js/lunr.min.js?1620971210></script><script type=text/javascript src=https://awslabs.github.io/aws-cloudfront-extensions/js/auto-complete.js?1620971210></script><script type=text/javascript>var baseurl="https:\/\/awslabs.github.io\/aws-cloudfront-extensions\/";</script><script type=text/javascript src=https://awslabs.github.io/aws-cloudfront-extensions/js/search.js?1620971210></script></div><div class=highlightable><ul class=topics><li data-nav-id=/prerequisite/ title=Prerequisite class=dd-item><a href=https://awslabs.github.io/aws-cloudfront-extensions/prerequisite/>Prerequisite</a><ul><li data-nav-id=/prerequisite/aws-cloudshell/readme/ title="AWS CloudShell" class=dd-item><a href=https://awslabs.github.io/aws-cloudfront-extensions/prerequisite/aws-cloudshell/readme/>AWS CloudShell</a></li><li data-nav-id=/prerequisite/aws-cdk/readme/ title="AWS CDK" class=dd-item><a href=https://awslabs.github.io/aws-cloudfront-extensions/prerequisite/aws-cdk/readme/>AWS CDK</a></li></ul></li><li data-nav-id=/deploy/ title="Deploy with CloudFront+" class="dd-item
parent"><a href=https://awslabs.github.io/aws-cloudfront-extensions/deploy/>Deploy with CloudFront+</a><ul><li data-nav-id=/deploy/deploy-auth/readme/ title="Deploy a Lambda@Edge function to authenticate with Cognito" class=dd-item><a href=https://awslabs.github.io/aws-cloudfront-extensions/deploy/deploy-auth/readme/>Deploy a Lambda@Edge function to authenticate with Cognito</a></li><li data-nav-id=/deploy/deploy-device/readme/ title="Deploy a Lambda@Edge function to serve based on devices" class="dd-item active"><a href=https://awslabs.github.io/aws-cloudfront-extensions/deploy/deploy-device/readme/>Deploy a Lambda@Edge function to serve based on devices</a></li></ul></li><li data-nav-id=/develop/ title="Develop with CloudFront+" class=dd-item><a href=https://awslabs.github.io/aws-cloudfront-extensions/develop/>Develop with CloudFront+</a><ul><li data-nav-id=/develop/cloudfront-distribution/readme/ title="Create a CloudFront Distribution" class=dd-item><a href=https://awslabs.github.io/aws-cloudfront-extensions/develop/cloudfront-distribution/readme/>Create a CloudFront Distribution</a></li><li data-nav-id=/develop/download-code/readme/ title="Upload CloudFront+ code into CloudShell" class=dd-item><a href=https://awslabs.github.io/aws-cloudfront-extensions/develop/download-code/readme/>Upload CloudFront+ code into CloudShell</a></li><li data-nav-id=/develop/code-structure/readme/ title="Understand CloudFront+ code structure" class=dd-item><a href=https://awslabs.github.io/aws-cloudfront-extensions/develop/code-structure/readme/>Understand CloudFront+ code structure</a></li><li data-nav-id=/develop/edge-function/readme/ title="Create a Lambda@Edge function" class=dd-item><a href=https://awslabs.github.io/aws-cloudfront-extensions/develop/edge-function/readme/>Create a Lambda@Edge function</a></li><li data-nav-id=/develop/test-function/readme/ title="Test the Lambda@Edge function" class=dd-item><a href=https://awslabs.github.io/aws-cloudfront-extensions/develop/test-function/readme/>Test the Lambda@Edge function</a></li><li data-nav-id=/develop/trigger-function/readme/ title="Trigger from CloudFront" class=dd-item><a href=https://awslabs.github.io/aws-cloudfront-extensions/develop/trigger-function/readme/>Trigger from CloudFront</a></li></ul></li><li data-nav-id=/contribution/ title=Contribution class=dd-item><a href=https://awslabs.github.io/aws-cloudfront-extensions/contribution/>Contribution</a><ul><li data-nav-id=/contribution/pr/readme/ title="Contributing via pull requests" class=dd-item><a href=https://awslabs.github.io/aws-cloudfront-extensions/contribution/pr/readme/>Contributing via pull requests</a></li><li data-nav-id=/contribution/bug-report/readme/ title="Reporting issues" class=dd-item><a href=https://awslabs.github.io/aws-cloudfront-extensions/contribution/bug-report/readme/>Reporting issues</a></li></ul></li><li data-nav-id=/cleanup/ title=Cleanup class=dd-item><a href=https://awslabs.github.io/aws-cloudfront-extensions/cleanup/>Cleanup</a><ul><li data-nav-id=/cleanup/s3-bucket/readme/ title="S3 bucket" class=dd-item><a href=https://awslabs.github.io/aws-cloudfront-extensions/cleanup/s3-bucket/readme/>S3 bucket</a></li><li data-nav-id=/cleanup/cf-distribution/readme/ title="CloudFront distribution" class=dd-item><a href=https://awslabs.github.io/aws-cloudfront-extensions/cleanup/cf-distribution/readme/>CloudFront distribution</a></li><li data-nav-id=/cleanup/cloudformation/readme/ title=CloudFormation class=dd-item><a href=https://awslabs.github.io/aws-cloudfront-extensions/cleanup/cloudformation/readme/>CloudFormation</a></li><li data-nav-id=/cleanup/cloudshell/readme/ title=CloudShell class=dd-item><a href=https://awslabs.github.io/aws-cloudfront-extensions/cleanup/cloudshell/readme/>CloudShell</a></li></ul></li><li data-nav-id=/reference/ title="Reference & Resources" class=dd-item><a href=https://awslabs.github.io/aws-cloudfront-extensions/reference/>Reference & Resources</a></li></ul><section id=footer><left><a class=github-button href=https://github.com/awslabs/aws-cloudfront-extensions data-icon=octicon-cloud-download aria-label="Repo of awslabs/aws-cloudfront-extension on GitHub">Repo</a>
<a class=github-button href=https://github.com/awslabs/aws-cloudfront-extensions data-icon=octicon-star data-show-count=false aria-label="Star awslabs/aws-cloudfront-extension on GitHub">Star</a>
<a class=github-button href=https://github.com/awslabs/aws-cloudfront-extensions/fork data-icon=octicon-repo-forked data-show-count=false aria-label="Fork awslabs/aws-cloudfront-extension on GitHub">Fork</a><p><a href="https://aws.amazon.com/privacy/?nc1=f_pr">Privacy</a> | <a href="https://aws.amazon.com/terms/?nc1=f_pr">Site Terms</a> | Â© 2021, Amazon Web Services, Inc. or its affiliates. All rights reserved</p></left><script async defer src=https://buttons.github.io/buttons.js></script></section></div></nav><section id=body><div id=overlay></div><div class="padding highlightable"><div><div id=top-bar><div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i></a></span><span id=toc-menu><i class="fas fa-list-alt"></i></span><span class=links><a href=https://awslabs.github.io/aws-cloudfront-extensions/>CloudFront+ workshop</a> > <a href=https://awslabs.github.io/aws-cloudfront-extensions/deploy/>Deploy with CloudFront+</a> > Deploy a Lambda@Edge function to serve based on devices</span></div><div class=progress><div class=wrapper><nav id=TableOfContents><ul><li><a href=#deploy-an-application-in-sar>Deploy an application in SAR</a></li><li><a href=#deploy-resources-by-cdk>Deploy resources by CDK</a></li><li><a href=#configuration-on-the-s3-bucket>Configuration on the S3 bucket</a></li><li><a href=#configuration-on-the-cloudfront-distribution>Configuration on the CloudFront distribution</a></li><li><a href=#add-a-cloudfront-trigger-to-run-the-function>Add a CloudFront Trigger to Run the Function</a></li><li><a href=#test-the-function>Test the function</a></li></ul></nav></div></div></div></div><div id=head-tags></div><div id=body-inner><h1>Deploy a Lambda@Edge function to serve based on devices</h1><p>In this step, you will find and deploy serverless applications that have been published to the AWS Serverless Application Repository, the application serves content based on device type, for example, mobile device will be forwarded to access content for mobile devices, desktop device will be forwarded to access specific content, and so on so forth</p><h2 id=deploy-an-application-in-sar>Deploy an application in SAR</h2><p>To find and configure an application in the AWS Serverless Application Repository</p><ol><li>Open <a href=https://serverlessrepo.aws.amazon.com/applications>the AWS Serverless Application Repository page</a></li><li>Check <strong>Show apps that create custom IAM roles or resource policies</strong></li><li>Search the application name <strong>serving-based-on-device</strong>, choose the application</li><li>On the application detail page, check <strong>I acknowledge that this app creates custom IAM roles</strong></li><li>Choose <strong>Deploy</strong>. After the deployment is completed, it will redirect to application over page</li></ol><h2 id=deploy-resources-by-cdk>Deploy resources by CDK</h2><p>To download CloudFront+ code and upload it onto CloudShell</p><blockquote><p>Skip this step if you already have the codes in CloudShell</p></blockquote><ol><li><p>Go to <a href=https://github.com/awslabs/aws-cloudfront-extensions>CloudFront+ code</a></p></li><li><p>Choose <strong>Download ZIP</strong>
<img src=https://awslabs.github.io/aws-cloudfront-extensions/images/gh-download.png alt="Github Download ZIP"></p></li><li><p>Upload the zip package onto CloudShell
<img src=https://awslabs.github.io/aws-cloudfront-extensions/images/cs-upload.png alt="CloudShell Upload"></p></li><li><p>Unzip the package into home folder</p><pre><code>unzip aws-cloudfront-extensions-main.zip
</code></pre><div class="notices note"><p>You can also clone the codes by SSH or Https.</p></div><blockquote><p>For SSH, you will need to setup the ssh key in your github account by following this <a href=https://docs.github.com/en/free-pro-team@latest/github/authenticating-to-github/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent>doc</a></p></blockquote><blockquote><p>For Https, you will need to enter the username and password. If you have enabled two-factor authentication(2FA), a <a href=https://docs.github.com/en/free-pro-team@latest/github/authenticating-to-github/creating-a-personal-access-token>personal access key</a> is needed to download the codes</p></blockquote></li></ol><p>To deploy the demo website</p><ol><li><p>Go to <a href="https://console.aws.amazon.com/cloudshell/home?region=us-east-1#">CloudShell</a></p><blockquote><p>In the top right corner of the console, make sure youâre using this region: <strong>N. Virginia (us-east-1)</strong></p></blockquote></li><li><p>Navigate to demo folder and deploy it, you need to specify an unique S3 bucket name to store the website content</p><pre><code>cd aws-cloudfront-extensions-main/templates/workshop-demo/
npm install
npm run build
cdk deploy --parameters staticSiteBucketName=&lt;your_unique_S3_bucket_name&gt;
</code></pre><p>Wait until the deployment is completed</p></li><li><p>Go to <a href="https://console.aws.amazon.com/cloudformation/home?region=us-east-1">CloudFormation console</a>, you will see a stack named <strong>WorkshopDemoStack</strong></p></li><li><p>Choose <strong>WorkshopDemoStack</strong> and click <strong>Outputs</strong> tab, it will show S3 bucket name, demo website url and CloudFront distribution id
<img src=https://awslabs.github.io/aws-cloudfront-extensions/images/output_device.png alt="Device output"></p></li></ol><h2 id=configuration-on-the-s3-bucket>Configuration on the S3 bucket</h2><ol><li><p>Go to <a href="https://s3.console.aws.amazon.com/s3/home?region=us-east-1">S3 console</a></p></li><li><p>Allow public read access for the objects in the S3 bucket because it will be serving as a public website</p><p>Choose <strong>Edit Block public access</strong>, uncheck <strong>block all public access</strong></p><blockquote><p>Be aware that every object in this bucket will become readable in public</p></blockquote></li><li><p>Choose <strong>Objects</strong> tab, choose all the files in the bucket and choose <strong>Actions</strong>, choose <strong>Make public</strong></p></li></ol><h2 id=configuration-on-the-cloudfront-distribution>Configuration on the CloudFront distribution</h2><ol><li><p>Open the <a href=https://console.aws.amazon.com/cloudfront/home#>CloudFront console</a></p></li><li><p>Choose the distribution that is shown in the outputs</p></li><li><p>Choose <strong>Behaviors</strong> tab and edit the default cache behavior</p></li><li><p>Do below configuration</p><ul><li><p>For <strong>Cache Based on Selected Request Headers</strong>, choose <strong>Whitelist</strong></p></li><li><p>For <strong>Whitelist Headers</strong>, add 4 custom headers</p><p>CloudFront-Is-Desktop-Viewer</p><p>CloudFront-Is-Mobile-Viewer</p><p>CloudFront-Is-SmartTV-Viewer</p><p>CloudFront-Is-Tablet-Viewer</p><blockquote><p>Based on the value of the User-Agent header, CloudFront sets the value of four headers to true or false before forwarding the request to your origin</p></blockquote></li><li><p>For <strong>Object Caching</strong>, choose <strong>Customize</strong></p><p>For Minimum TTL, enter 0</p><p>For Maximum TTL, enter 0</p><p>For Default TTL, enter 0</p><blockquote><p>This is to disable cache in CloudFront, it will make sure that every request will be reach origin and miss from CloudFront</p></blockquote></li><li><p>Choose <strong>Yes, Edit</strong> to save the changes</p></li></ul><p><img src=https://awslabs.github.io/aws-cloudfront-extensions/images/cf-config-device.png alt="Device CF config"></p></li></ol><h2 id=add-a-cloudfront-trigger-to-run-the-function>Add a CloudFront Trigger to Run the Function</h2><p>To configure the CloudFront trigger for your function</p><ol><li><p>Go to <a href="https://console.aws.amazon.com/lambda/home?region=us-east-1#/functions">Lambda console</a> and choose serving-based-on-device function which is deployed from SAR</p></li><li><p>Choose <strong>Configuration</strong> tab and choose <strong>Triggers</strong></p></li><li><p>Add Trigger and choose <strong>CloudFront</strong>, choose <strong>Deploy to Lambda@Edge</strong></p><p><img src=https://awslabs.github.io/aws-cloudfront-extensions/images/CF_trigger.png alt="CF Trigger"></p></li><li><p>On the <strong>Deploy to Lambda@Edge</strong> page, enter the following information:</p><ul><li><p>Distribution</p><p>The CloudFront distribution which has been created in the stack</p></li><li><p>CloudFront event</p><p>In the drop-down list, choose <strong>Origin request</strong></p></li></ul><p>Choose <strong>Deploy</strong></p><p><img src=https://awslabs.github.io/aws-cloudfront-extensions/images/deploy_para.png alt="Lambda Deploy"></p></li><li><p>Wait for the function to replicate. This typically takes several minutes</p><p>You can check to see if replication is finished by going to the <a href=https://console.aws.amazon.com/cloudfront/>CloudFront console</a> and viewing your distribution. Wait for the distribution status to change from In Progress back to <strong>Deployed</strong>, which means that your function has been replicated</p></li></ol><h2 id=test-the-function>Test the function</h2><ol><li><p>Open the demo website url in your PC which is shown in the stack outputs</p><p>It will show <strong>T-Rex Runner for Desktop</strong> and x-cache will be <strong>miss from cloudfront</strong> or <strong>refreshhit from cloudfront</strong></p><p><img src=https://awslabs.github.io/aws-cloudfront-extensions/images/test_desktop.png alt="Device test result desktop"></p></li><li><p>Open the demo website url in your mobile phone browser or simulate it in your desktop browser</p><p>It will show <strong>T-Rex Runner for Mobile</strong> and x-cache will be <strong>miss from cloudfront</strong> or <strong>refreshhit from cloudfront</strong></p><p><img src=https://awslabs.github.io/aws-cloudfront-extensions/images/test_mobile.png alt="Device test result mobile"></p></li></ol><footer class=footline></footer></div></div><div id=navigation><a class="nav nav-prev" href=https://awslabs.github.io/aws-cloudfront-extensions/deploy/deploy-auth/readme/ title="Deploy a Lambda@Edge function to authenticate with Cognito"><i class="fa fa-chevron-left"></i></a><a class="nav nav-next" href=https://awslabs.github.io/aws-cloudfront-extensions/develop/ title="Develop with CloudFront+" style=margin-right:0><i class="fa fa-chevron-right"></i></a></div></section><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=https://awslabs.github.io/aws-cloudfront-extensions/js/clipboard.min.js?1620971210></script><script src=https://awslabs.github.io/aws-cloudfront-extensions/js/perfect-scrollbar.min.js?1620971210></script><script src=https://awslabs.github.io/aws-cloudfront-extensions/js/perfect-scrollbar.jquery.min.js?1620971210></script><script src=https://awslabs.github.io/aws-cloudfront-extensions/js/jquery.sticky.js?1620971210></script><script src=https://awslabs.github.io/aws-cloudfront-extensions/js/featherlight.min.js?1620971210></script><script src=https://awslabs.github.io/aws-cloudfront-extensions/js/highlight.pack.js?1620971210></script><script>hljs.initHighlightingOnLoad();</script><script src=https://awslabs.github.io/aws-cloudfront-extensions/js/modernizr.custom-3.6.0.js?1620971210></script><script src=https://awslabs.github.io/aws-cloudfront-extensions/js/learn.js?1620971210></script><script src=https://awslabs.github.io/aws-cloudfront-extensions/js/hugo-learn.js?1620971210></script><script src=https://awslabs.github.io/aws-cloudfront-extensions/mermaid/mermaid.js?1620971210></script><script>mermaid.initialize({startOnLoad:true});</script></body></html>